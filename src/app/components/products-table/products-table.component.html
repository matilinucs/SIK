<div class="products-table-container" (click)="onTableClick($event)">  <!-- Encabezado -->  <div class="table-header">
    <h2>Productos en Cubicación - Proyecto Santa Marta</h2>
    <div class="table-actions">
      <button mat-raised-button color="primary" [matMenuTriggerFor]="exportMenu" class="action-button export-button" matTooltip="Exportar">
        <mat-icon>file_download</mat-icon> Exportar
      </button>
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportToExcel()">
          <mat-icon>description</mat-icon>
          <span>Exportar Excel</span>
        </button>
      </mat-menu>      <button mat-raised-button color="primary" class="action-button add-button" (click)="addProduct.emit()" matTooltip="Agregar producto">
        <mat-icon>add</mat-icon> Agregar Producto
      </button>
    </div>
  </div>
  
  <!-- Sección de Filtros -->
  <div class="filters-container">
    <form [formGroup]="filterForm" class="filters-form">
      <!-- Búsqueda general -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Buscar producto</mat-label>
        <input matInput formControlName="search" 
               placeholder="Buscar por código, tipo, material...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <!-- Filtro por tipo de ventana -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Tipo de Ventana</mat-label>
        <mat-select formControlName="type">
          <mat-option [value]="null">Todos</mat-option>
          <mat-option *ngFor="let type of productTypes" [value]="type">
            {{type}}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Filtro por tipo de material -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Material</mat-label>
        <mat-select formControlName="materialType">
          <mat-option [value]="null">Todos</mat-option>
          <mat-option *ngFor="let material of productMaterials" [value]="material">
            {{material}}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Filtros de rango de cantidad -->
      <div class="filter-group">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Cantidad Mín.</mat-label>
          <input matInput type="number" formControlName="minQuantity" 
                 placeholder="0" min="0">
        </mat-form-field>
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Cantidad Máx.</mat-label>
          <input matInput type="number" formControlName="maxQuantity" 
                 placeholder="999" min="0">
        </mat-form-field>
      </div>

      <!-- Filtros de rango de presupuesto -->
      <div class="filter-group">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Presupuesto Mín.</mat-label>
          <input matInput type="number" formControlName="minBudget" 
                 placeholder="0" min="0">
          <span matPrefix>$&nbsp;</span>
        </mat-form-field>
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Presupuesto Máx.</mat-label>
          <input matInput type="number" formControlName="maxBudget" 
                 placeholder="999999" min="0">
          <span matPrefix>$&nbsp;</span>
        </mat-form-field>
      </div>

      <!-- Filtros de rango de superficie -->
      <div class="filter-group">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Superficie Mín. (m²)</mat-label>
          <input matInput type="number" formControlName="minArea" 
                 placeholder="0" min="0">
        </mat-form-field>
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Superficie Máx. (m²)</mat-label>
          <input matInput type="number" formControlName="maxArea" 
                 placeholder="999" min="0">
        </mat-form-field>
      </div>

      <!-- Botón para limpiar filtros -->
      <div class="button-container">
        <button mat-stroked-button color="warn" (click)="clearFilters()" class="clear-filters-button">
          <mat-icon>clear_all</mat-icon>
          Limpiar Filtros
        </button>
      </div>
    </form>
  </div>

  <!-- Contenedor principal con scroll -->
  <div class="table-content">
    <div class="table-scroll">
      <!-- Tabla -->
      <table mat-table [dataSource]="productsDataSource" class="products-table">
        <!-- Columna de Selección -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef class="selection-checkbox-header-cell">
            <mat-checkbox (change)="masterToggle()"
                          [checked]="isAllSelected()"
                          [indeterminate]="selectedProductIds.size > 0 && !isAllSelected()"
                          (click)="$event.stopPropagation()"
                          matTooltip="Seleccionar/Deseleccionar todo">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let product" class="selection-checkbox-cell">
            <mat-checkbox (change)="onRowCheckboxChange($event, product)"
                          [checked]="isRowSelected(product)"
                          (click)="$event.stopPropagation()"
                          aria-label="Seleccionar producto {{product.productCode}}">
            </mat-checkbox>
          </td>
        </ng-container>

        <!-- Código de Producto -->
        <ng-container matColumnDef="productCode">
          <th mat-header-cell *matHeaderCellDef>Código</th>
          <td mat-cell *matCellDef="let product" class="code-cell">{{product.productCode}}</td>
        </ng-container>

        <!-- Tipo de Ventana -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>Tipo de Ventana</th>
          <td mat-cell *matCellDef="let product">{{product.type}}</td>
        </ng-container>

        <!-- Cantidad -->
        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef>Cantidad</th>
          <td mat-cell *matCellDef="let product">{{product.quantity}}</td>
        </ng-container>

        <!-- Superficie Total -->
        <ng-container matColumnDef="totalArea">
          <th mat-header-cell *matHeaderCellDef>Superficie Total</th>
          <td mat-cell *matCellDef="let product" class="area-cell">
            {{product.totalArea | number:'1.2-2'}} <span class="unit">m²</span>
          </td>
        </ng-container>

        <!-- Presupuesto -->
        <ng-container matColumnDef="budget">
          <th mat-header-cell *matHeaderCellDef>Presupuesto</th>
          <td mat-cell *matCellDef="let product" class="amount-cell">
            {{product.budget | currency:'USD'}}
          </td>
        </ng-container>

        <!-- Acciones -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-cell">Acciones</th>
          <td mat-cell *matCellDef="let product" class="actions-cell">
            <!-- Botón fijar (alfiler) -->
            <button mat-icon-button color="accent" (click)="onPin(product, $event)" matTooltip="Fijar producto">
              <mat-icon>push_pin</mat-icon>
            </button>
            <!-- Botón editar -->
            <button mat-icon-button color="primary" (click)="onEdit(product, $event)" matTooltip="Editar">
              <mat-icon>edit</mat-icon>
            </button>
            <!-- Botón eliminar -->
            <button mat-icon-button color="warn" (click)="onDelete(product, $event)" matTooltip="Eliminar">
              <mat-icon>delete</mat-icon>
            </button>
            <!-- Menú de acciones (3 puntitos) -->
            <button mat-icon-button [matMenuTriggerFor]="moreMenu" (click)="$event.stopPropagation()" matTooltip="Más acciones">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #moreMenu="matMenu">
              <button mat-menu-item (click)="onDuplicate(product, $event)">
                <mat-icon>content_copy</mat-icon>
                <span>Duplicar</span>
              </button>
              <button mat-menu-item (click)="onRepeat(product, $event)">
                <mat-icon>repeat</mat-icon>
                <span>Repetir fila</span>
              </button>
              <button mat-menu-item (click)="onCopy(product, $event)">
                <mat-icon>file_copy</mat-icon>
                <span>Copiar</span>
              </button>
            </mat-menu>
          </td>
        </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"
          [ngClass]="{'pinned-row': pinnedProductIds.has(row.id), 'selected-row': isRowSelected(row)}" 
          (click)="onRowClick(row)"> <!-- Added onRowClick and selected-row class -->
      </tr>

        <!-- Mensaje cuando no hay productos -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell no-data-cell" [attr.colspan]="displayedColumns.length">
            <div class="no-data-message">
              <mat-icon>inventory_2</mat-icon>
              <p>No hay productos agregados a la cubicación</p>
            </div>
          </td>
        </tr>
      </table>
    </div>
  </div>

  <!-- Footer con resumen -->
  <div class="table-footer" *ngIf="productsDataSource.data.length > 0">
    <div class="summary-info">
      <div class="summary-item">
        <span class="label">Total de productos:</span>
        <span class="value">{{getTotalProducts()}}</span>
      </div>
      <div class="summary-item">
        <span class="label">Superficie total:</span>
        <span class="value">{{getTotalArea() | number:'1.2-2'}} m²</span>
      </div>
      <div class="summary-item total">
        <span class="label">Presupuesto total:</span>
        <span class="value">{{getTotalBudget() | currency:'USD'}}</span>
      </div>
    </div>
  </div>
</div>
